<div class="container container-wide">
  <h1 class="page-title mb-2r">üõçÔ∏è Cat√°logo de Productos</h1>
  
  <div class="mb-2r center">
    <form method="GET" class="row justify-center">
      <input type="text" name="query" placeholder="Buscar por categor√≠a o disponibilidad (true/false)" value="{{query}}" class="form-control max-420">
      <select name="sort" class="form-control max-200">
        <option value="">Sin ordenar</option>
        <option value="asc" {{#if (eq sort "asc")}}selected{{/if}}>Precio Ascendente</option>
        <option value="desc" {{#if (eq sort "desc")}}selected{{/if}}>Precio Descendente</option>
      </select>
      <button type="submit" class="btn btn-primary">
        Filtrar
      </button>
    </form>
  </div>

  <div class="grid-products">
    {{#each products}}
    <div class="card">
      <div class="card-body">
        <h3 class="card-title">{{title}}</h3>
        <p class="text-muted" style="margin-bottom: 1rem; font-size: 0.9rem;">{{description}}</p>
        <div class="row-between mb-1r" style="margin-bottom: 1rem;">
          <span class="price">${{price}}</span>
          <span class="text-muted" style="font-size: 0.9rem;">Stock: {{stock}}</span>
        </div>
        <div style="margin-bottom: 1rem; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <span class="badge badge-gray">
            {{category}}
          </span>
          {{#if (gt stock 0)}}
            <span class="badge badge-status available">Disponible</span>
          {{else}}
            <span class="badge badge-status unavailable">No disponible</span>
          {{/if}}
        </div>
        <div style="display: flex; gap: 8px;">
          <a href="/products/{{toString _id}}" class="btn btn-primary" style="flex:1; text-align:center; font-size:0.9rem; text-decoration:none;">
            Ver Detalles
          </a>
          {{#if (gt stock 0)}}
            <button onclick="addToCartSession('{{toString _id}}')" class="btn btn-success btn-sm">
              üõí
            </button>
          {{else}}
            <button disabled class="btn btn-gray btn-sm">
              Sin stock
            </button>
          {{/if}}
        </div>
      </div>
    </div>
    {{/each}}
  </div>

  {{#if (or hasPrevPage hasNextPage)}}
  <div class="pagination">
    {{#if hasPrevPage}}
    <a href="?page={{prevPage}}{{#if query}}&query={{query}}{{/if}}{{#if sort}}&sort={{sort}}{{/if}}" 
       class="btn-primary" style="text-decoration:none; padding: 8px 16px; border-radius: 6px;">
      ‚Üê Anterior
    </a>
    {{/if}}
    
    <span class="text-muted">P√°gina {{currentPage}} de {{totalPages}}</span>
    
    {{#if hasNextPage}}
    <a href="?page={{nextPage}}{{#if query}}&query={{query}}{{/if}}{{#if sort}}&sort={{sort}}{{/if}}" 
       class="btn-primary" style="text-decoration:none; padding: 8px 16px; border-radius: 6px;">
      Siguiente ‚Üí
    </a>
    {{/if}}
  </div>
  {{/if}}
</div>

<script>
function addToCart(productId) {
  if (window.addToCartSession) {
    window.addToCartSession(productId);
  } else {
    fetch('/api/carts', { method: 'POST' })
      .then(r => r.json())
      .then(cart => fetch(`/api/carts/${cart._id}/product/${productId}`, { method: 'POST' }))
      .then(r => r.json())
      .then(() => alert('Producto agregado al carrito'))
      .catch(() => alert('Error al agregar producto'));
  }
}
</script>
